-- Helper: generate N spaces
CREATE FUNCTION Spaces(n INTEGER) RETURNS CHARACTER
BEGIN
  DECLARE s CHARACTER '';
  DECLARE i INTEGER 1;
  WHILE i <= n DO
    SET s = s || ' ';
    SET i = i + 1;
  END WHILE;
  RETURN s;
END;

-- Main: Normalize a field from InputRoot.DFDL
CREATE FUNCTION NormalizeField(inField CHARACTER, inLength INTEGER) RETURNS CHARACTER
BEGIN
  DECLARE tmpBlob BLOB;
  DECLARE tmpCHAR CHARACTER;

  -- Default empty input to space(s)
  IF inField IS NULL OR inField = '' THEN
    SET tmpCHAR = Spaces(inLength);
  ELSE
    -- Try to round-trip through BLOB CCSID 273 (EBCDIC)
    BEGIN
      SET tmpBlob = CAST(inField AS BLOB CCSID 273);
      SET tmpCHAR = CAST(tmpBlob AS CHARACTER CCSID 1208);  -- force to ASCII/UTF-8
    END;

    -- If that fails, just use original value
    IF tmpCHAR IS NULL OR tmpCHAR = '' THEN
      SET tmpCHAR = inField;
    END IF;
  END IF;

  -- Pad/trim to schema length
  RETURN SUBSTRING(tmpCHAR || Spaces(inLength) FROM 1 FOR inLength);
END;
